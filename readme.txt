============================================================
 ehgm.pl - Downloader from E-Hentai, ExHentai, and Lo-Fi - 
                                                2011/01/10
============================================================

====
概要
====
  E-Hentai, ExHentai, Lo-Fiからのダウンロード支援スクリプト
  改変，再配布はご自由に（NYSL Version 0.9982）

========
必要環境
========
  Windows/Linux
  perl 5.8以上
  以下の非標準 Perl モジュール
    WWW::Mechanizeモジュール
    HTML::Entitiesモジュール

============
インストール
============
  ehgm.pl のシェバン行（1行目）と基本設定部分（11～39行目）
  を環境とお好みに応じて変更してください．
  
==================
コマンドライン書式
==================
  $ ehgm.pl [URL | FILE] [DIRECTORY] [options]

  URL はダウンロード対象のIndexページのアドレス，
  （http://g.e-hentai.org/g/123456/d123456789/ など）
  またはダウンロードを開始したい個別ページのアドレス．
  （http://g.e-hentai.org/s/d123456789/123456-10 など）
            
  FILE はキューリストが記述されたファイル．

  DIRECTORY は画像を保存するディレクトリ．

==========
オプション
==========
  -d directory    
    画像を保存するディレクトリを指定．
    ディレクトリ名がオプション名と衝突するときや，タイトル名
    がファイルシステムで使用できない文字で構成されている場合
    に利用．
    デフォルトは $defaultBaseDir 以下に作品タイトル名のディ
    レクトリが作成される．

  -D directory    
    自動生成されるディレクトリの基準となるディレクトリを指定．
    デフォルトは $defaultBaseDir．

  -f num
    ダウンロードを開始するページ数を指定．
    デフォルトは1．
    
  -h
    ヘルプを表示．
     
  -l num
    ダウンロードを終了するページ数を指定．
    デフォルトは $maxPageNum (=2000)．
     
  -p proxy
    プロキシを指定．
    デフォルトは環境変数HTTP_PROXY．
     
  -P file
    プロキシリストファイルを指定．
    下記に詳細．
     
  -q file
    キューリストファイルを指定．
    ファイル名がオプションと衝突するときに利用．
    キューリストファイルについては下記に詳細．
    
  -r file
    レジューム用ログファイルを指定.
    デフォルトは $defaultResumeLogFile
    （= ./resume_年月日時分秒.txt）.
    下記に詳細．
    
  -t url
    サムネイル画像のアドレスを指定．
    下記に詳細．
   （古い版との互換性のため．2011/01/10版以降は必要ない．）

======
使用例
======

  単一作品をダウンロード
    $ ehgm.pl http://g.e-hentai.org/g/123456/d123456789/
    $ ehgm.pl http://g.e-hentai.org/s/d123456789/123456-1

  ヘルプを表示
    $ ehgm.pl -h

  途中からDLを行う（レジューム処理などに）
   $ ehgm.pl URL -f 10

  途中までDLを行う（デバッグ時などに）
   $ ehgm.pl URL -l 20

  指定範囲のみDLする
    $ ehgm.pl URL -f 10 -l 20
    $ ehgm.pl URL -f 15 -l 15
    
  ExHentaiからIndexのない作品をダウンロードする
 （古い版との互換性のため．2011/01/10版以降は必要ない）
    $ ehgm.pl URL -t サムネイル画像のURL

  特定のプロキシを利用する
    $ ehgm.pl URL -p http://localhost:8080    
    $ ehgm.pl URL -p 192.168.0.2:80
    
  プロキシリストを利用する
    $ ehgm.pl URL -P proxy_list.txt

  キューリストに基づく一括ダウンロード
    $ ehgm.pl queue_list.txt

  キューリストとプロキシリストに基づく一括ダウンロード
    $ ehgm.pl queue_list.txt -P proxy_list.txt
    $ ehgm.pl resume_20101130123040.txt -P proxy_list.txt

============================
プロキシリストファイルの書式
============================
  適当なテキストファイルの各行に
   ”(http://)アドレス:ポート番号”
  という形式で，使用したいプロキシを羅列します．
  行頭の http:// は任意です．
  
  例：proxy_list.txt
    192.168.0.2:80
    http://localhost:8080

==========================
キューリストファイルの書式
==========================
  適当なテキストファイルの各行に
  ”URL [DIRECTORY] [options]”
  という形式で，ダウンロードしたい作品のindex/PAGEのURLとオ
  プションを羅列します．
  ただし，キューリストファイルの指定とヘルプフラグは無視され
  ます．
  ehgm.pl に与えれば，各作品が順にダウンロードされます．
  
  例：queue_list.txt
    http://g.e-hentai.org/g/30870/e556702250/
    http://g.e-hentai.org/g/30871/e556702251/ -f 10
    http://exhentai.org/g/30872/e556702252/ 

==========
レジューム
==========
  キューリストに基づく一括ダウンロードの実行時，ダウンロード
  に失敗した作品についてはレジューム用のログがファイルに出力
  されます（デフォルトは./resume_年月日時分秒.txt，ただし時
  刻はスクリプト起動時のもの．）

  このログファイルは一括ダウンロード用のキューリストと同じ書
  式で，ダウンロードに失敗したページからダウンロードを開始す
  るように書かれています．
  ehgm.pl にキューリストとして与えれば，各作品のダウンロード
  が再開されます．

=======================
サムネイル画像のURL指定
=======================
  ExHentai からダウンロードを行う時， -t オプションでサムネ
  イル画像のURLを指定すると，Indexページにアクセスできない場
  合でも，個別ページのアドレスを推定してダウンロードを行いま
  す．サムネイル画像のURLはhttp://から始まる絶対パス形式でも，
  トップページのHTMLソースに書かれている相対パス形式 （たとえ
  ば /ab/cd/abcd123456…….jpg）のどちらでも認識します．
  Lo-Fiのサムネイルでも構いませんが，個別ページの推定処理自
  体はExHentaiのIndexページのアドレスが与えられたときにのみ
  行われます．
  <2011/01/10追記>
  サムネイル画像を指定しなくても個別ページのURLを推定するよう
  になりました．古い版との互換性のために機能は残してありますが，
  新たに利用する必要ありません．

====
制限
====
  ファイルシステムの文字コード（$FSCharset）に割り当てること
  のできない文字（cp932に対するアラビア文字等）がタイトルに
  使われている場合，デフォルトの保存先ディレクトリとインター
  ネットショートカットのファイル名は通常のタイトル名に基づく
  ものではなくではなく，アドレスに基づいたものとなります．



============================================================
  以下、元の作者とは違う人が追記
                                                2020/06/07
============================================================

タイトルにダメ文字を含んでるとディレクトリの作成に失敗して死
ぬ問題に対処しました。
ダメ文字を含んでいる場合、URLをディレクトリ名に採用します。

元のソース的には独自でダメ文字の対応を行っているようなので本
来は問題が起きないような気はするのですが…私の環境では止まっ
てしまいます。謎…

環境:
- Win7 SP1 64bit
- Strawberry Perl 5.26.1.1-32bit

Strawberry perl が悪いんですかねぇ…よく解らん…
というか python おじさんなので perl よく解らん…
ニワカでいじくった。今は反省していない

ちなみに問題を起こしている箇所は、ソース後ろの方の `mkpath()`
内の `File::Basename::dirname()` で、ダメ文字含んでいた場合
に正しく親ディレクトリが取得できてない…という事っぽいです。
たぶん。
誰かダメ文字でもフォルダ作ってくれるように改修して下さいな


